---
title: "Social diversity in the EDH dataset"
author: "Petra Hermankova"
date: "11/01/2021"
output:
  html_document:
    theme: united
    toc: yes
    toc_float: true
    number_sections: true
    toc_depth: 2
    df_print: paged
---

# Initial setup

## Setup of the environment:

```{r setup, echo=TRUE, message=FALSE}
devtools::install_github("sdam-au/sdam") # loading SDAM custom package, if not working try devtools::install_github("mplex/cedhar", subdir="pkg/sdam")
#devtools::install_github("mplex/cedhar", subdir="pkg/sdam")
library(tidyverse)
library(sdam)
library(jsonlite)
library(leaflet)
library(googlesheets4)
```

## Loading data
1. Load the dataset, if you have Sciencedata.dk credentials

```{r, echo=FALSE}
mycred_secret<- readLines("~/mysecret.txt")
```

```{r, loading data}
resp = request("EDH_text_lemmatized_perseus_2021-01-21.json", path="/sharingin/648597@au.dk/SDAM_root/SDAM_data/EDH/public", method="GET", cred=mycred_secret)
```

```{r, echo=FALSE}
remove(mycred_secret)
```

2. Make a list and tibble from the request function
```{r}
list_json <- jsonlite::fromJSON(resp)
EDH_tibble <- as_tibble(list_json)
```

3. Display the first 6 records
```{r}
head(EDH_tibble)
```

# Text mining of lemmatized inscriptions

## Horizontal stratification - occupations
Dictionary of occupations based on Walzting 1900, 1-128, Petrikovits 1981a, 83-115, Petrikovits 1981b, 295-306.

They were manually transcribed into a spreasheet, categorised based on Harris 2002, and cross checked with the entries in Lewis-Short dictionary.

```{r}
gs4_deauth() # de-uthorized mode, no need of authentication token (if the spreadsheet is public)
occup_dict<- read_sheet("https://docs.google.com/spreadsheets/d/1nONTEwp42CVnq3iCiONrFbJedIcYtBV-l4Bil5mU7Eo/edit?usp=sharing", sheet = "Occupation")
```

### Counting occupations in the full corpus

## Search in non lemmatized text
```{r}
occupations_token<- EDH_tibble %>%
  filter(token %in% occup_dict$Term | token %in% occup_dict$Vocab_nom_sg) 

occupations_token %>% 
  count(token, sort = TRUE) %>%
  na.omit() %>% 
  print()

# how many instances of vocabulary
nrow(occupations_token)

# how many unique inscriptions
length(unique(occupations_token$id_num))
```

## Search in lemmatized text
```{r}
occupations_lemma<- EDH_tibble %>%
  filter(lemma %in% occup_dict$Term | lemma %in% occup_dict$Vocab_nom_sg) 

occupations_lemma %>% 
  count(lemma, sort = TRUE) %>% 
  na.omit() %>% 
  print()

# how many instances of vocabulary
nrow(occupations_lemma)

# how many unique inscriptions
length(unique(occupations_lemma$id_num))
```

```{r}
occupations_lemma - occupations_token
```



### Subsetting the dataset with occupations in lemmatized and non-lemmatized text combined
```{r}
occupations_text <- EDH_tibble %>%
  filter(lemma %in% occup_dict$Term | lemma %in% occup_dict$Vocab_nom_sg | token %in% occup_dict$Term | token %in% occup_dict$Vocab_nom_sg) %>% 
  print()

# how many unique occupations in token
length(unique(occupations_text$token))

# how many unique occupations in lemma
length(unique(occupations_text$lemma))

```

### Comparing the quality of data 

```{r}
occupations_text %>% 
  filter(token == lemma) %>% 
  select(token, lemma)
```

```{r}
occupations_text %>% 
  filter(token != lemma) %>% 
  select(token, lemma) %>% 
  count(lemma, token, sort = T)
```

Fixing bad lemmas manually

```{r}
gs4_deauth() # de-uthorized mode, no need of authentication token (if the spreadsheet is public)
fixing_lemma<- read_sheet("https://docs.google.com/spreadsheets/d/1nONTEwp42CVnq3iCiONrFbJedIcYtBV-l4Bil5mU7Eo/edit?usp=sharing", sheet = "Lemma_fixing")
```
```{r}
fixing_lemma
```

# Not working probably need to write a loop?
```{r}
occupations_text$lemma_fixed <- gsub(pattern = fixing_lemma$lemma_old, x = occupations_text$lemma, replacement = fixing_lemma$lemma_new)


occupations_text %>% 
  filter(lemma == "nauo") %>% 
  select(token, lemma, lemma_fixed)
```


### Location

#### Province
```{r}
occupations_text %>% 
  count(province_label_clean, sort=TRUE)
```

#### Findspot
```{r}
occupations_text %>% 
  count(findspot_ancient_clean, sort=TRUE)
```


### Mapping the occupations inscriptions
```{r} 
occupations_spatial<- occupations_text %>% 
  separate(col = coordinates, into = c("longitude", "latitude"), sep = ",")

# unlist coordinates and preparing them for leaflet
occupations_spatial$latitude <- as.numeric(str_replace(occupations_spatial$latitude, pattern = "\\)", replacement=""))
occupations_spatial$longitude <- as.numeric(str_replace(occupations_spatial$longitude, pattern = "c\\(", replacement=""))

# how many have longitude
length(na.omit(occupations_spatial$longitude))

# eliminating NA values
occupations_spatial <- occupations_spatial %>% 
  filter(longitude != "NA")
```

```{r}
map_occupations <-leaflet(width="100%") %>%
  #addProviderTiles("Stamen.Watercolor")%>% 
  #addProviderTiles("Esri.WorldTopoMap", group = "Topo") %>%
  addProviderTiles("Esri.WorldImagery", group = "ESRI Aerial") %>% # Add CartoDB map tiles
  setView(lng = 22.326743, lat = 46.897122, zoom = 4 ) %>%
  addCircles(lng = occupations_spatial$longitude, 
             lat = occupations_spatial$latitude, radius = 10, fill = TRUE, color= "purple" , fillColor = "purple",
             popup = paste0("<b> InscriptionID: </b>", occupations_spatial$id_num, 
                            "<br><b> Ancient findspot: </b>", occupations_spatial$findspot_ancient_clean,
                             "<br><b> Type of inscription: </b>", occupations_spatial$type_of_inscription_clean,
                              "<br><b> Type of monument: </b>", occupations_spatial$type_of_monument_clean,
                              "<br><b> Not before (date): </b>", occupations_spatial$not_before,
                              "<br><b> Not after (date): </b>", occupations_spatial$not_after
                                ),
) %>% 
addLegend(position = "topright",
  colors = c("Purple"),
  labels = c("Inscription findspot"), opacity = 1,
  title = "Position of inscriptions with occupations (EDH)" 
)
map_occupations
```





## Vertical stratification - professional organisations

Dictionary of professional organisations based on Walzting 1900, 1-128.

```{r}
gs4_deauth() # de-uthorized mode, no need of authentication token (if the spreadsheet is public)
organisation_dict<- read_sheet("https://docs.google.com/spreadsheets/d/1nONTEwp42CVnq3iCiONrFbJedIcYtBV-l4Bil5mU7Eo/edit?usp=sharing", sheet ="Organisation")
organisation_dict
```


### Counting occurences
```{r}
organisations<- EDH_tibble %>%
  count(lemma, sort = TRUE) %>%
  filter(lemma %in% organisation_dict$Term ) %>% 
  na.omit() %>% 
  print()
```

### Subsetting the dataset containing the organisational terms in lemma
```{r}
organisations_text <- EDH_tibble %>%
  filter(lemma %in% organisation_dict$Term) %>% 
  print()
```

```{r}
organisations_text %>% 
  count(findspot_ancient_clean, sort=TRUE)
```


```{r}
organisations_text %>% 
  count(lemma, token, sort=TRUE)
```


### Mapping the organisations inscriptions

```{r} 
organisations_spatial<- organisations_text %>% 
  separate(col = coordinates, into = c("longitude", "latitude"), sep = ",")

# unlist coordinates and preparing them for leaflet
organisations_spatial$latitude <- as.numeric(str_replace(organisations_spatial$latitude, pattern = "\\)", replacement=""))
organisations_spatial$longitude <- as.numeric(str_replace(organisations_spatial$longitude, pattern = "c\\(", replacement=""))

# how many have longitude
length(na.omit(organisations_spatial$longitude))
```


```{r}
map_organisations <-leaflet(width="100%") %>%
  #addProviderTiles("Stamen.Watercolor")%>% 
  #addProviderTiles("Esri.WorldTopoMap", group = "Topo") %>%
  addProviderTiles("Esri.WorldImagery", group = "ESRI Aerial") %>% # Add CartoDB map tiles
  setView(lng = 22.326743, lat = 46.897122, zoom = 4 ) %>%
  addCircles(lng = organisations_spatial$longitude, 
             lat = organisations_spatial$latitude, radius = 10, fill = TRUE, color= "yellow" , fillColor = "yellow",
             popup = paste0("<b> InscriptionID: </b>", organisations_spatial$id_num, 
                            "<br><b> Ancient findspot: </b>", organisations_spatial$findspot_ancient_clean,
                             "<br><b> Type of inscription: </b>", organisations_spatial$type_of_inscription_clean,
                              "<br><b> Type of monument: </b>", organisations_spatial$type_of_monument_clean,
                              "<br><b> Not before (date): </b>", organisations_spatial$not_before,
                              "<br><b> Not after (date): </b>", organisations_spatial$not_after
                                ),
) %>% 
addLegend(position = "topright",
  colors = c("Yellow"),
  labels = c("Inscription findspot"), opacity = 1,
  title = "Position of inscriptions with organisations (EDH)" 
)
map_organisations
```







