---
title: "Spatial exploration"
author: "Petra Hermankova"
date: "27/01/2021"
output:
  html_document:
    theme: united
    toc: yes
    toc_float: true
    number_sections: true
    toc_depth: 2
    df_print: paged
---

# Initial setup

## Setup of the environment:

```{r setup, echo=TRUE, message=FALSE}
devtools::install_github("sdam-au/sdam") # loading SDAM custom package, if not working try devtools::install_github("mplex/cedhar", subdir="pkg/sdam")
#devtools::install_github("mplex/cedhar", subdir="pkg/sdam")
library(tidyverse)
library(sdam)
library(jsonlite)
library(leaflet)
library(googlesheets4)
```

## Loading data
1. Load the dataset, if you have Sciencedata.dk credentials

```{r, echo=FALSE}
mycred_secret<- readLines("~/mysecret.txt")
```

```{r, loading data}
resp = request("EDH_text_lemmatized_perseus_2021-01-21.json", path="/sharingin/648597@au.dk/SDAM_root/SDAM_data/EDH/public", method="GET", cred=mycred_secret)
```

```{r, echo=FALSE}
remove(mycred_secret)
```

2. Make a list and tibble from the request function
```{r}
list_json <- jsonlite::fromJSON(resp)
EDH_tibble <- as_tibble(list_json)
```

3. Display the first 6 records
```{r}
head(EDH_tibble)
```


# Spatial analysis of inscriptions

## Creating buffer zones around cities 
Source of the cities dataset Hanson 2016.
```{r}
cities<- as.data.frame(read_csv("http://oxrep.classics.ox.ac.uk/oxrep/docs/Hanson2016/Hanson2016_Cities_OxREP.csv"))
```

```{r}
library(raster)
library(sf)

#set projection as EPSG 3035 (centroid in Germany) / ETRS89

cities_geo<- st_as_sf(cities, coords = c("Longitude (X)", "Latitude (Y)"))
cities_geo<- st_set_crs(cities_geo, 3035) 
cities_geo<- st_transform(cities_geo, 3035, "+units=m")

# check the projection
st_crs(cities_geo)
crs(cities_geo)

#Set buffer zone to 5 km
cities_5km<- st_buffer(cities_geo, dist = 5000)
cities_20km<- st_buffer(cities_geo, dist = 20000)

```
### Plotting the buffer
```{r}
plot_sf(cities_geo)
plot(st_geometry(cities_5km), col = "yellow", add = TRUE)
#plot(st_geometry(cities_geo), pch=20, cex = 0.1, add = TRUE)
```

### Plotting with tmap
```{r}
library(tmap)

# Test
c_buf <- cities_5km %>% slice(1:1000)
c <- cities_geo %>% slice(1:1000)

tm_shape(c_buf)  +
 tm_polygons(col = "pink") +
 tm_shape(c) +
 tm_dots(col = "blue",
            size = 0.1) +
 tm_scale_bar(breaks = c(0, 0.5, 1.0),
              text.size = 2,
              position = c("LEFT", "bottom")) +
 tm_compass(position = c("LEFT", "bottom"),
            type = "rose",
            size = 2)
```

### Projecting occupations
```{r}
occupations_geo <- st_as_sf(occupations_spatial, coords = c("longitude", "latitude"))
occupations_geo <- st_set_crs(occupations_geo, 3035) %>% st_transform(3035, "+units=m")
st_crs(occupations_geo)
```


### Spatial subsetting of inscriptions based on buffers around cities

```{r}
occupations_df<- st_sf(occupations_geo)
cities_5km_df<- st_sf(cities_5km)

occupations_5km_cont <- st_contains(cities_5km_df, occupations_df)
cont <- occupations_5km_cont[[1]]

occupations_5km_int <- st_intersects(cities_5km_df, occupations_df)
int <- occupations_5km_int[[1]]

occupations_5km_clip <- st_intersection(cities_5km, occupations_geo)
```
### Spatial join of buffers around cities and occupations 20 km
```{r}
occupations_df<- st_sf(occupations_geo)
cities_20km_df<- st_sf(cities_20km)

occupations_20km_cont <- st_contains(cities_20km_df, occupations_df)
cont <- occupations_20km_cont[[1]]

occupations_20km_int <- st_intersects(cities_20km_df, occupations_df)
int <- occupations_20km_int[[1]]

occupations_20km_clip <- st_intersection(cities_20km, occupations_geo)
```

```{r}
plot(st_geometry(occupations_5km_clip))
plot(occupations_df, add = TRUE, col = "blue")
#plot(st_geometry(occupations_20km_clip), add = TRUE, col = "green")
#plot(st_geometry(occupations_5km_clip), add = TRUE, col = "red")
```
```{r}
head(occupations_5km_clip)
```
Number of unique inscriptions containing occupation and spatial info
```{r}
length(unique(occupations_geo$id_num))
length(unique(occupations_5km_clip$id_num))
length(unique(occupations_20km_clip$id_num))
```

Inscriptions containing occupation found within 5k buffer from Ancient.Toponym counted by Ancient.Toponym
```{r}
occupations_5km_clip %>% 
  count(Ancient.Toponym, sort=TRUE) %>% 
  head()
```

Inscriptions containing occupation found within 5k buffer from Ancient.Toponym counted by province
```{r}
occupations_5km_clip %>% 
  count(Province, sort=TRUE) %>% 
  head()
```

Inscriptions containing occupation found within 20k buffer from Ancient.Toponym counted by Ancient.Toponym
```{r}
occupations_20km_clip %>% 
  count(Ancient.Toponym, sort=TRUE) %>% 
  head()
```

Inscriptions containing occupation found within 20k buffer from Ancient.Toponym counted by province
```{r}
occupations_20km_clip %>% 
  count(Province, sort=TRUE) %>% 
  head()
```

Number of unique occupations
```{r}
length(unique(occupations_geo$lemma))
length(unique(occupations_5km_clip$lemma))
length(unique(occupations_20km_clip$lemma))
```


Next:
compute distance to te nearest city

```{r}
library(sf)
occ_distance <- st_distance(cities_geo, occupations_geo)
max(occ_distance)

occ_nearest_city <- which.min(occ_distance)

occupations_geo[occ_nearest_city,]
```


```{r}
View(occ_distance)
```





```{r}
map_occupations_cities <-leaflet(width="100%") %>%
  #addProviderTiles("Stamen.Watercolor")%>% 
  addProviderTiles("Esri.WorldTopoMap", group = "Topo") %>%
  #addProviderTiles("Esri.WorldImagery", group = "ESRI Aerial") %>% # Add CartoDB map tiles
  setView(lng = 22.326743, lat = 46.897122, zoom = 4 ) %>%
  addCircles(lng = occupations_spatial$longitude, 
             lat = occupations_spatial$latitude, radius = 10, fill = TRUE, color= "purple" , fillColor = "purple",
             popup = paste0("<b> InscriptionID: </b>", occupations_spatial$id_num, 
                            "<br><b> Ancient findspot: </b>", occupations_spatial$findspot_ancient_clean,
                             "<br><b> Type of inscription: </b>", occupations_spatial$type_of_inscription_clean,
                              "<br><b> Type of monument: </b>", occupations_spatial$type_of_monument_clean,
                              "<br><b> Not before (date): </b>", occupations_spatial$not_before,
                              "<br><b> Not after (date): </b>", occupations_spatial$not_after
                                ),
) %>% 
  addCircles(lng = cities$`Longitude (X)`, 
             lat = cities$`Latitude (Y)`, fill = TRUE, radius=10) %>% 
  addLegend(position = "topright",
    colors = c("Purple"),
    labels = c("Inscription findspot"), opacity = 1,
    title = "Position of inscriptions with occupations (EDH)" 
)
map_occupations_cities
```

